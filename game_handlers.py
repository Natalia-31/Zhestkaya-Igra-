from aiogram import Router, F, Bot
from aiogram.filters import Command
from aiogram.types import (
    Message,
    InlineKeyboardMarkup,
    InlineKeyboardButton,
    CallbackQuery
)
import json
import random
from game_utils import gen, get_random_situation

router = Router()
HAND_SIZE = 10
GAMES = {}  # chat_id ‚Üí { players, host_index, situation, hands, answers }

# –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–ª–æ–¥—ã –∫–∞—Ä—Ç
with open("cards.json", "r", encoding="utf-8") as f:
    ALL_CARDS = json.load(f)

def main_menu_kb() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        inline_keyboard=[[
            InlineKeyboardButton(text="‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –∏–≥—Ä—É", callback_data="new_game"),
            InlineKeyboardButton(text="‚ûï –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è", callback_data="join_game"),
            InlineKeyboardButton(text="üé≤ –ù–æ–≤—ã–π —Ä–∞—É–Ω–¥", callback_data="start_round"),
        ]]
    )

@router.message(Command("new_game"))
async def cmd_new_game(message: Message):
    GAMES[message.chat.id] = {
        "players": [],
        "host_index": 0,
        "situation": None,
        "hands": {},
        "answers": []
    }
    await message.answer(
        "‚úÖ –ò–≥—Ä–∞ –Ω–∞—á–∞—Ç–∞! –ò–≥—Ä–æ–∫–∏ –º–æ–≥—É—Ç –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫–æ–º–∞–Ω–¥–æ–π /join_game –∏–ª–∏ –∫–Ω–æ–ø–∫–æ–π –Ω–∏–∂–µ.",
        reply_markup=main_menu_kb()
    )

@router.callback_query(F.data == "new_game")
async def cb_new_game(callback: CallbackQuery):
    GAMES[callback.message.chat.id] = {
        "players": [],
        "host_index": 0,
        "situation": None,
        "hands": {},
        "answers": []
    }
    await callback.answer("–ò–≥—Ä–∞ –Ω–∞—á–∞—Ç–∞!", show_alert=False)
    await callback.message.edit_reply_markup(reply_markup=main_menu_kb())

@router.message(Command("join_game"))
async def cmd_join_game(message: Message):
    game = GAMES.get(message.chat.id)
    if not game:
        return await message.answer("–°–Ω–∞—á–∞–ª–∞ –Ω–∞—á–Ω–∏—Ç–µ –∏–≥—Ä—É: /new_game", reply_markup=main_menu_kb())
    uid = message.from_user.id
    if uid not in game["players"]:
        game["players"].append(uid)
    await message.answer(
        f"‚ûï {message.from_user.full_name} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è!",
        reply_markup=main_menu_kb()
    )

@router.callback_query(F.data == "join_game")
async def cb_join_game(callback: CallbackQuery):
    game = GAMES.get(callback.message.chat.id)
    if not game:
        return await callback.answer("–°–Ω–∞—á–∞–ª–∞ –Ω–∞—á–Ω–∏—Ç–µ –∏–≥—Ä—É.", show_alert=True)
    uid = callback.from_user.id
    if uid not in game["players"]:
        game["players"].append(uid)
    await callback.answer(f"{callback.from_user.full_name} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è!", show_alert=False)
    await callback.message.edit_reply_markup(reply_markup=main_menu_kb())

@router.message(Command("start_round"))
async def cmd_start_round(message: Message):
    await _start_round_logic(message.bot, message.chat.id, message.from_user.id)

@router.callback_query(F.data == "start_round")
async def cb_start_round(callback: CallbackQuery):
    await callback.answer()
    await _start_round_logic(callback.bot, callback.message.chat.id, callback.from_user.id)

async def _start_round_logic(bot: Bot, chat_id: int, starter_id: int):
    game = GAMES.get(chat_id)
    if not game or not game["players"]:
        return await bot.send_message(chat_id, "–°–Ω–∞—á–∞–ª–∞ /new_game –∏ /join_game", reply_markup=main_menu_kb())
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ–¥—É—â–µ–≥–æ –ø–æ –∫—Ä—É–≥—É
    idx = game["host_index"] % len(game["players"])
    host_id = game["players"][idx]
    game["host_index"] += 1
    game["answers"].clear()
    game["hands"].clear()
    # –°–∏—Ç—É–∞—Ü–∏—è
    situation = get_random_situation()
    game["situation"] = situation
    host_member = await bot.get_chat_member(chat_id, host_id)
    host_name = host_member.user.full_name
    await bot.send_message(
        chat_id,
        f"üé¨ –†–∞—É–Ω–¥ –Ω–∞—á–∞–ª—Å—è! üëë –í–µ–¥—É—â–∏–π: {host_name}\n\nüé≤ {situation}"
    )
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—é —Å–∏—Ç—É–∞—Ü–∏–∏
    await gen.send_situation_with_image(bot, chat_id)
    # –†–∞–∑–¥–∞—ë–º –∫–∞—Ä—Ç—ã
    deck = ALL_CARDS.copy()
    random.shuffle(deck)
    for uid in game["players"]:
        if uid == host_id:
            continue
        hand = [deck.pop() for _ in range(HAND_SIZE)]
        game["hands"][uid] = hand
        kb = InlineKeyboardMarkup(
            inline_keyboard=[
                [InlineKeyboardButton(text=card, callback_data=f"ans:{i}")]
                for i, card in enumerate(hand)
            ]
        )
        try:
            await bot.send_message(uid, "–í–∞—à–∞ —Ä—É–∫–∞ ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É-–æ—Ç–≤–µ—Ç:", reply_markup=kb)
        except:
            pass  # –ï—Å–ª–∏ –±–æ—Ç –Ω–µ –º–æ–∂–µ—Ç –Ω–∞–ø–∏—Å–∞—Ç—å –≤ –ª–∏—á–∫—É

@router.callback_query(F.data.startswith("ans:"))
async def cb_answer(callback: CallbackQuery):
    chat_id = callback.message.chat.id
    uid = callback.from_user.id
    game = GAMES.get(chat_id)
    if not game:
        return
    # –í–µ–¥—É—â–∏–π –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
    host_idx = (game["host_index"] - 1) % len(game["players"])
    if uid == game["players"][host_idx]:
        return await callback.answer("–í–µ–¥—É—â–∏–π –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç.", show_alert=True)
    idx = int(callback.data.split(":", 1)[1])
    hand = game["hands"].get(uid, [])
    if idx < 0 or idx >= len(hand):
        return await callback.answer("–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä.", show_alert=True)
    card = hand.pop(idx)
    game["answers"].append((uid, card))
    await callback.answer(f"–í—ã –≤—ã–±—Ä–∞–ª–∏: {card}")
    # –ï—Å–ª–∏ –≤—Å–µ –æ—Ç–≤–µ—Ç–∏–ª–∏
    if len(game["answers"]) >= len(game["players"]) - 1:
        text = "–û—Ç–≤–µ—Ç—ã –∏–≥—Ä–æ–∫–æ–≤:\n" + "\n".join(f"{i+1}. {c}" for i, (_, c) in enumerate(game["answers"]))
        kb = InlineKeyboardMarkup(
            inline_keyboard=[
                [InlineKeyboardButton(text=str(i+1), callback_data=f"pick:{i}")]
                for i in range(len(game["answers"]))
            ]
        )
        await bot.send_message(chat_id, text, reply_markup=kb)

@router.callback_query(F.data.startswith("pick:"))
async def cb_pick(callback: CallbackQuery):
    chat_id = callback.message.chat.id
    game = GAMES.get(chat_id)
    if not game:
        return
    # –¢–æ–ª—å–∫–æ –≤–µ–¥—É—â–∏–π –≤—ã–±–∏—Ä–∞–µ—Ç
    host_idx = (game["host_index"] - 1) % len(game["players"])
    host_id = game["players"][host_idx]
    if callback.from_user.id != host_id:
        return await callback.answer("–¢–æ–ª—å–∫–æ –≤–µ–¥—É—â–∏–π –º–æ–∂–µ—Ç –≤—ã–±–∏—Ä–∞—Ç—å.", show_alert=True)
    idx = int(callback.data.split(":", 1)[1])
    uid, card = game["answers"][idx]
    winner_member = await callback.bot.get_chat_member(chat_id, uid)
    winner_name = winner_member.user.full_name
    await callback.message.edit_text(f"üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: {winner_name}\n–û—Ç–≤–µ—Ç: {card}")
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏
    combined = f"{game['situation']} ____ {card}"
    image_path = await gen.generate_image_from_situation(combined, f"round_{chat_id}")
    if image_path:
        await callback.bot.send_photo(chat_id, photo=image_path)
    # –ú–µ–Ω—é –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞
    await callback.bot.send_message(chat_id, "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞:", reply_markup=main_menu_kb())
