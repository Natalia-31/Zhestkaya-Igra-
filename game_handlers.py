from aiogram import Router, F, Bot
from aiogram.filters import Command, CommandStart
from aiogram.types import Message
import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from game_utils import send_random_situation_with_image, get_random_situation

router = Router()

@router.message(CommandStart())
async def cmd_start(message: Message):
    """–°—Ç–∞—Ä—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞."""
    await message.answer(
        "üéÆ **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ñ–µ—Å—Ç–∫—É—é –ò–≥—Ä—É!**\n\n"
        "–≠—Ç–æ –≤–µ—Å—ë–ª–∞—è –∏–≥—Ä–∞ —Å —Å–∏—Ç—É–∞—Ü–∏—è–º–∏ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏!\n\n"
        "**–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**\n"
        "‚Ä¢ `/start_round` - –Ω–∞—á–∞—Ç—å —Ä–∞—É–Ω–¥ —Å —Å–∏—Ç—É–∞—Ü–∏–µ–π –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º\n"
        "‚Ä¢ `/situation` - –ø–æ–ª—É—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é\n"
        "‚Ä¢ `/test_image` - —Ç–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è\n"
        "‚Ä¢ `/help` - –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É",
        parse_mode="Markdown"
    )

@router.message(Command("help"))
async def cmd_help(message: Message):
    """–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º."""
    await message.answer(
        "üéÆ **–ñ–µ—Å—Ç–∫–∞—è –ò–≥—Ä–∞ - –°–ø—Ä–∞–≤–∫–∞**\n\n"
        "**–ö–æ–º–∞–Ω–¥—ã:**\n"
        "‚Ä¢ `/start_round` - –∑–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞\n"
        "‚Ä¢ `/situation` - –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å–∏—Ç—É–∞—Ü–∏–∏\n"
        "‚Ä¢ `/test_image` - –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è\n\n"
        "**–ö–∞–∫ –∏–≥—Ä–∞—Ç—å:**\n"
        "1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ä–∞—É–Ω–¥ –∫–æ–º–∞–Ω–¥–æ–π /start_round\n"
        "2. –ü–æ–ª—É—á–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫ –Ω–µ–π\n"
        "3. –ü—Ä–∏–¥—É–º–∞–π—Ç–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –æ—Ç–≤–µ—Ç!\n"
        "4. –í–µ—Å–µ–ª–∏—Ç–µ—Å—å! üéâ",
        parse_mode="Markdown"
    )

@router.message(Command("start_round"))
async def start_game_round(message: Message):
    """–ù–∞—á–∏–Ω–∞–µ—Ç –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥ —Å —Å–∏—Ç—É–∞—Ü–∏–µ–π –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º."""
    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–≤–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
        await message.answer(
            "üéÆ **–ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥ –ñ–µ—Å—Ç–∫–æ–π –ò–≥—Ä—ã!**\n\n"
            "–°–µ–π—á–∞—Å —è –ø–æ–∫–∞–∂—É –≤–∞–º —Å–∏—Ç—É–∞—Ü–∏—é –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É—é –∫ –Ω–µ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...",
            parse_mode="Markdown"
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏—Ç—É–∞—Ü–∏—é —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
        success = await send_random_situation_with_image(
            message.bot, 
            message.chat.id
        )
        
        if success:
            await message.answer(
                "‚úÖ **–ì–æ—Ç–æ–≤–æ!** –¢–µ–ø–µ—Ä—å –∏–≥—Ä–æ–∫–∏ –º–æ–≥—É—Ç –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—é!\n\n"
                "–ü—Ä–∏–¥—É–º–∞–π—Ç–µ —Å–∞–º—ã–π –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –∏ —Å–º–µ—à–Ω–æ–π –æ—Ç–≤–µ—Ç! üéØ",
                parse_mode="Markdown"
            )
        else:
            await message.answer(
                "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –Ω–æ –∏–≥—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è!\n\n"
                "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É `/situation` —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—É—é —Å–∏—Ç—É–∞—Ü–∏—é.",
                parse_mode="Markdown"
            )
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ —Ä–∞—É–Ω–¥–∞: {e}")
        await message.answer(
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ä–∞—É–Ω–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥."
        )

@router.message(Command("situation"))
async def get_situation_only(message: Message):
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å–∏—Ç—É–∞—Ü–∏–∏ –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è."""
    try:
        situation = get_random_situation()
        await message.answer(
            f"üé≤ **–°–ª—É—á–∞–π–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:**\n\n_{situation}_\n\n"
            f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/start_round` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏—Ç—É–∞—Ü–∏–∏ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º!",
            parse_mode="Markdown"
        )
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏—Ç—É–∞—Ü–∏–∏: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏—Ç—É–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

@router.message(Command("test_image"))
async def test_image_generation(message: Message):
    """–¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π."""
    try:
        await message.answer("üé® **–¢–µ—Å—Ç–∏—Ä—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...**\n\n–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 30 —Å–µ–∫—É–Ω–¥.")
        
        success = await send_random_situation_with_image(
            message.bot,
            message.chat.id
        )
        
        if not success:
            await message.answer(
                "‚ùå **–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è**\n\n"
                "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n"
                "‚Ä¢ –ù–µ–≤–µ—Ä–Ω—ã–π OPENAI_API_KEY\n"
                "‚Ä¢ –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤\n"
                "‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º\n\n"
                "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            )
        else:
            await message.answer("‚úÖ **–¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω!** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.")
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
@router.message()
async def unknown_command(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–æ–º–∞–Ω–¥."""
    await message.answer(
        "ü§î –ù–µ –ø–æ–Ω–∏–º–∞—é —ç—Ç—É –∫–æ–º–∞–Ω–¥—É.\n\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/help` –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.",
        parse_mode="Markdown"
    )
